name: Build Windows Portable with Icon

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-portable:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Create default icon (if not exists)
        run: |
          # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –∏–∫–æ–Ω–∫—É –ø—Ä–æ–≥—Ä–∞–ºmatically –∫–∞–∫ fallback
          $iconDir = "src/main/resources/icons"
          if (-not (Test-Path $iconDir)) {
            New-Item -ItemType Directory -Path $iconDir -Force
          }
          if (-not (Test-Path "$iconDir/app.ico")) {
            Write-Host "No icon found, jpackage will use default icon"
          }

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Create Portable App Image with Icon
        run: |
          # Clean release directory
          Remove-Item -Path "release" -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path "release" -Force
          
          Write-Host "=== Creating portable app-image with icon ==="
          
          # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è jpackage
          $jpackageArgs = @(
            '--type', 'app-image',
            '--input', 'target/',
            '--main-jar', 'nbdsig-1.0-SNAPSHOT.jar',
            '--main-class', 'com.example.Launcher',
            '--name', 'PDFSignerPro',
            '--app-version', '2.0.0',
            '--vendor', 'Anatoly Dyrul',
            '--copyright', 'Copyright 2024',
            '--description', 'Professional PDF Signature Visualization System',
            '--dest', 'release/',
            '--verbose'
          )
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if (Test-Path "src/main/resources/icons/app.ico") {
            $jpackageArgs += '--icon'
            $jpackageArgs += 'src/main/resources/icons/app.ico'
            Write-Host "Using custom icon: src/main/resources/icons/app.ico"
          } else {
            Write-Host "Using default icon (custom icon not found)"
          }
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º jpackage
          jpackage @jpackageArgs

      - name: Verify App Image
        run: |
          Write-Host "=== Verifying app-image ==="
          if (Test-Path "release/PDFSignerPro") {
            $exePath = "release/PDFSignerPro/PDFSignerPro.exe"
            if (Test-Path $exePath) {
              Write-Host "SUCCESS: Portable app created at $exePath"
              Write-Host "File size: $((Get-Item $exePath).Length / 1MB) MB"
            } else {
              Write-Host "ERROR: EXE file not found in app-image"
              exit 1
            }
          } else {
            Write-Host "ERROR: App-image directory not created"
            exit 1
          }

      - name: Create Enhanced Launcher BAT file
        run: |
          Write-Host "=== Creating enhanced launcher BAT file ==="
          $batContent = @"
  @echo off
  chcp 65001 > nul
  title PDF Signer Pro v2.0.0
  echo ========================================
  echo     PDF Signer Pro - Portable Edition
  echo ========================================
  echo.
  echo –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...
  echo.
  cd /d "%~dp0PDFSignerPro"
  PDFSignerPro.exe
  if %errorlevel% neq 0 (
  echo.
  echo –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!
  echo –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É.
  echo.
  )
  pause
  "@
        Set-Content -Path "release/–ó–∞–ø—É—Å—Ç–∏—Ç—å PDF Signer Pro.bat" -Value $batContent -Encoding UTF8
  
  # –¢–∞–∫–∂–µ —Å–æ–∑–¥–∞–µ–º –∞–Ω–≥–ª–∏–π—Å–∫—É—é –≤–µ—Ä—Å–∏—é
  $batContentEN = @"
  @echo off
  chcp 65001 > nul
  title PDF Signer Pro v2.0.0
  echo ========================================
  echo     PDF Signer Pro - Portable Edition
  echo ========================================
  echo.
  echo Starting application...
  echo.
  cd /d "%~dp0PDFSignerPro"
  PDFSignerPro.exe
  if %errorlevel% neq 0 (
  echo.
  echo Error starting application!
  echo Make sure antivirus is not blocking the program.
  echo.
  )
  pause
  "@
        Set-Content -Path "release/Start PDF Signer Pro.bat" -Value $batContentEN -Encoding UTF8

- name: Create Comprehensive README
  run: |
    $readmeContent = @"
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë            PDF SIGNER PRO v2.0.0              ‚ïë
  ‚ïë        Portable Edition - –ó–∞–ø—É—Å–∫ –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìÅ –°–û–î–ï–†–ñ–ê–ù–ò–ï –ê–†–•–ò–í–ê:
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  PDFSignerPro/          - –ü–∞–ø–∫–∞ —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
  ‚îú‚îÄ‚îÄ PDFSignerPro.exe   - –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
  ‚îú‚îÄ‚îÄ app/               - –§–∞–π–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  ‚îî‚îÄ‚îÄ runtime/           - –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è Java
  
  –ó–∞–ø—É—Å—Ç–∏—Ç—å PDF Signer Pro.bat  - –†—É—Å—Å–∫–∏–π –∑–∞–ø—É—Å–∫–∞—Ç–µ–ª—å
  Start PDF Signer Pro.bat      - English launcher

üöÄ –ö–ê–ö –ó–ê–ü–£–°–¢–ò–¢–¨:
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–°–ü–û–°–û–ë 1 (–ü—Ä–æ—Å—Ç–æ–π):
  1. –î–≤–∞–∂–¥—ã —â–µ–ª–∫–Ω–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å PDF Signer Pro.bat"

–°–ü–û–°–û–ë 2 (–ü—Ä—è–º–æ–π):
  1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–ø–∫—É "PDFSignerPro"
  2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ "PDFSignerPro.exe"

‚ö° –û–°–û–ë–ï–ù–ù–û–°–¢–ò:
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏
  ‚úÖ –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –Ω–∞ USB-—Ñ–ª–µ—à–∫–µ
  ‚úÖ –ù–µ –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ª–µ–¥–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ
  ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
  ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Java
  ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞

üõ°Ô∏è –í–ê–ñ–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ‚Ä¢ –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å –º–æ–∂–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ
  –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É - –Ω—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–ø—É—Å–∫
  ‚Ä¢ –î–ª—è —Ä–∞–±–æ—Ç—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è Windows 10/11 (64-bit)
‚Ä¢ –†–∞–∑–º–µ—Ä: ~150-200 MB (–≤–∫–ª—é—á–∞—è Java)

üìû –ü–û–î–î–ï–†–ñ–ö–ê:
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–í–µ—Ä—Å–∏—è: 2.0.0
–ê–≤—Ç–æ—Ä: Anatoly Dyrul

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å:
  ‚Ä¢ PDF –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
  ‚Ä¢ –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å—è–º–∏ (.sig)
  ‚Ä¢ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π —à—Ç–∞–º–ø–æ–≤ –≠–ü
  "@
        Set-Content -Path "release/!!!–ü–†–û–ß–¢–ò –ú–ï–ù–Ø!!!.txt" -Value $readmeContent -Encoding UTF8
  
  - name: Create Desktop INI for nice folder icon
run: |
  # –°–æ–∑–¥–∞–µ–º desktop.ini –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–ø–∫–∏
  $desktopIni = @"
  [.ShellClassInfo]
  IconResource=PDFSignerPro\PDFSignerPro.exe,0
  [ViewState]
  Mode=
  Vid=
  FolderType=Generic
  "@
        Set-Content -Path "release/desktop.ini" -Value $desktopIni -Encoding ASCII
  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã –∫–∞–∫ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ñ–∞–π–ª
  attrib +s +h "release/desktop.ini" 2>$null
  
  - name: Create Final ZIP Archive
run: |
  Write-Host "=== Creating final ZIP archive ==="
  
  # –°–æ–∑–¥–∞–µ–º ZIP —Å –∫—Ä–∞—Å–∏–≤—ã–º –∏–º–µ–Ω–µ–º
  $zipName = "PDFSignerPro-v2.0.0-Portable.zip"
  Compress-Archive -Path "release/*" -DestinationPath $zipName -Force
  
  Write-Host "ZIP archive created: $zipName"
  Write-Host "ZIP size: $((Get-Item $zipName).Length / 1MB) MB"

- name: Upload Portable ZIP
  uses: actions/upload-artifact@v4
  with:
    name: PDFSignerPro-Portable-v2.0.0
    path: PDFSignerPro-v2.0.0-Portable.zip
    retention-days: 90

- name: Upload Individual Files (for testing)
  uses: actions/upload-artifact@v4
  with:
    name: PDFSignerPro-Files-Debug
    path: release/
    retention-days: 7

- name: Create GitHub Release
  if: startsWith(github.ref, 'refs/tags/')
  uses: softprops/action-gh-release@v1
  with:
    files: |
      PDFSignerPro-v2.0.0-Portable.zip
    body: |
      # PDF Signer Pro v2.0.0 - Portable Edition
      
      ## üöÄ Portable –≤–µ—Ä—Å–∏—è - –∑–∞–ø—É—Å–∫ –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏!
      
      ### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
      - ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏
      - ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–ª–µ—à–∫–∏
      - ‚úÖ –ù–µ –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–ª–µ–¥–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ
      - ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç Java
      - ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è
      
      ### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
      1. –°–∫–∞—á–∞–π—Ç–µ –∏ —Ä–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤
      2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `–ó–∞–ø—É—Å—Ç–∏—Ç—å PDF Signer Pro.bat`
      3. –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ `PDFSignerPro.exe` –Ω–∞–ø—Ä—è–º—É—é
      
      ### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
      - Windows 10/11 (64-bit)
      - ~200 MB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞