name: Build Windows Portable

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-portable:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Create Portable App Image
        run: |
          # Clean release directory
          Remove-Item -Path "release" -Recurse -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path "release" -Force
          
          Write-Host "=== Creating portable app-image ==="
          jpackage `
            --type app-image `
            --input target/ `
            --main-jar nbdsig-1.0-SNAPSHOT.jar `
            --main-class com.example.Launcher `
            --name "PDFSignerPro" `
            --app-version "2.0.0" `
            --vendor "Anatoly Dyrul" `
            --description "PDF Signature Visualization System" `
            --dest release/ `
            --verbose

      - name: Create Launcher BAT file
        run: |
          Write-Host "=== Creating launcher BAT file ==="
          $batContent = @"
  @echo off
  chcp 65001 > nul
  echo Starting PDF Signer Pro...
  cd /d "%~dp0"
  PDFSignerPro\PDFSignerPro.exe
  pause
  "@
        Set-Content -Path "release/Start-PDFSignerPro.bat" -Value $batContent -Encoding ASCII

- name: Create README for portable version
  run: |
    $readmeContent = @"
# PDF Signer Pro - Portable Version

## Как запустить:

  1. Распакуйте эту папку в любое место
  2. Запустите `Start-PDFSignerPro.bat`
  3. ИЛИ запустите `PDFSignerPro\PDFSignerPro.exe` напрямую

## Особенности:
- Не требует установки
- Можно переносить на флешке
- Не оставляет следов в системе
- Не требует прав администратора

## Системные требования:
- Windows 10/11 (64-bit)
- Не требует установки Java

Версия: 2.0.0
  "@
        Set-Content -Path "release/README.txt" -Value $readmeContent -Encoding UTF8
  
  - name: Create Portable ZIP
run: |
  Write-Host "=== Creating portable ZIP ==="
  Compress-Archive -Path "release/*" -DestinationPath "PDFSignerPro-Portable-2.0.0.zip" -Force

- name: Upload Portable ZIP
  uses: actions/upload-artifact@v4
  with:
    name: PDFSignerPro-Portable
    path: PDFSignerPro-Portable-2.0.0.zip
    retention-days: 30

- name: Upload Individual Files
  uses: actions/upload-artifact@v4
  with:
    name: PDFSignerPro-Files
    path: release/
    retention-days: 30