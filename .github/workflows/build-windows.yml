name: Build Windows EXE - Fixed

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Clean release directory
        run: |
          if (Test-Path "release") {
            Remove-Item -Recurse -Force "release"
          }
          New-Item -ItemType Directory -Path "release" -Force

      - name: Create App Image
        run: |
          Write-Host "=== Creating app-image ==="
          jpackage `
            --type app-image `
            --input target/ `
            --main-jar nbdsig-1.0-SNAPSHOT.jar `
            --main-class com.example.Launcher `
            --name "PDFSignerPro" `
            --app-version "2.0.0" `
            --vendor "Anatoly Dyrul" `
            --dest release/ `
            --verbose
          Write-Host "App-image created successfully"

      - name: Check App Image
        run: |
          Write-Host "=== Checking app-image ==="
          if (Test-Path "release/PDFSignerPro") {
            Get-ChildItem "release/PDFSignerPro" -Recurse
            Write-Host "App-image exists"
          } else {
            Write-Host "ERROR: App-image not created"
            exit 1
          }

      - name: Create EXE from App Image
        run: |
          Write-Host "=== Creating EXE from app-image ==="
          jpackage `
            --type exe `
            --app-image release/PDFSignerPro `
            --name "PDFSignerPro" `
            --dest release/ `
            --win-shortcut `
            --win-menu
          Write-Host "EXE created successfully"

      - name: Verify EXE File
        run: |
          Write-Host "=== Final files in release ==="
          Get-ChildItem "release" -Recurse
          
          $exeFiles = Get-ChildItem "release" -Filter "*.exe"
          if ($exeFiles) {
            Write-Host "SUCCESS: EXE file found!"
            $exeFiles | ForEach-Object { Write-Host "EXE: $($_.Name)" }
          } else {
            Write-Host "ERROR: No EXE file found"
            exit 1
          }

      - name: Upload EXE Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PDFSignerPro-Windows
          path: release/*.exe
          retention-days: 30

      - name: Create Portable ZIP
        run: |
          if (Test-Path "release/PDFSignerPro") {
            Compress-Archive -Path "release/PDFSignerPro/*" -DestinationPath "release/PDFSignerPro-Portable.zip"
            Write-Host "Portable ZIP created"
          }

      - name: Upload Portable Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: PDFSignerPro-Portable
          path: release/PDFSignerPro-Portable.zip
          retention-days: 30